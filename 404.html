<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Deep Search</title>
    <style>
        /* Hacker/Terminal Theme */
        body {
            background-color: #0d1117;
            color: #c9d1d9;
            font-family: Consolas, "Courier New", monospace;
            white-space: pre-wrap; /* Preserve formatting */
            padding: 20px;
            font-size: 14px;
            line-height: 1.6;
            max-width: 1000px;
            margin: 0 auto;
        }
        .log { color: #8b949e; font-style: italic; }
        .success { color: #3fb950; font-weight: bold; }
        .error { color: #ff7b72; }
        .highlight { color: #d2a8ff; border-bottom: 1px solid #d2a8ff; }
        hr { border: 1px dashed #30363d; margin: 20px 0; }
        h1, h2, h3 { color: #f0f6fc; margin-top: 30px; }
    </style>
</head>
<body><div id="terminal">Initializing System...</div>

<script>
    const term = document.getElementById('terminal');
    const PROXY_BASE = "https://api.allorigins.win/get?url=";

    function log(text) {
        term.innerHTML += `<div class="log">> ${text}</div>`;
    }

    function printContent(title, text, url) {
        term.innerHTML = ""; // Clear logs
        term.innerHTML += `SOURCE: [${title}](${url})\n`;
        term.innerHTML += `==================================================\n\n`;
        term.innerHTML += text;
    }

    function error(msg) {
        term.innerHTML += `<div class="error">ERROR: ${msg}</div>`;
    }

    async function run() {
        // 1. Parse URL: /search/query/number/
        const path = window.location.pathname;
        const parts = path.split('/search/');
        
        if (parts.length < 2) {
            error("Invalid URL. Format: /search/your-query/1/");
            return;
        }

        const params = parts[1].split('/'); // ["query", "1", ""]
        const query = decodeURIComponent(params[0]);
        // Default to result #1 if no number provided
        const resultIndex = params[1] ? parseInt(params[1]) : 1; 

        if (!query) {
            error("No query found.");
            return;
        }

        document.title = `Fetching: ${query} (#${resultIndex})`;
        log(`Target Protocol: Search for "${query}"`);
        log(`Target Index: #${resultIndex}`);

        // 2. SEARCH PHASE (DuckDuckGo)
        log("Contacting Search Provider via Proxy...");
        const ddgUrl = `https://html.duckduckgo.com/html/?q=${encodeURIComponent(query)}`;
        
        try {
            const searchResp = await fetch(PROXY_BASE + encodeURIComponent(ddgUrl));
            const searchData = await searchResp.json();
            
            if (!searchData.contents) throw new Error("Proxy failed to fetch search results.");

            const parser = new DOMParser();
            const doc = parser.parseFromString(searchData.contents, "text/html");
            
            // Get all results
            const results = doc.querySelectorAll('.result__a');
            
            // Validate Index
            const actualIndex = resultIndex - 1; // Array starts at 0, users count from 1
            if (!results[actualIndex]) {
                throw new Error(`Result #${resultIndex} not found. (Only found ${results.length} results)`);
            }

            const targetLink = results[actualIndex].getAttribute('href');
            log(`Result Found: ${targetLink}`);
            log(`Phase 2: Extracting content from external site...`);

            // 3. SCRAPE PHASE (The Target Site)
            await scrapeWebsite(targetLink);

        } catch (err) {
            error(err.message);
        }
    }

    async function scrapeWebsite(url) {
        try {
            const resp = await fetch(PROXY_BASE + encodeURIComponent(url));
            const data = await resp.json();
            
            if (!data.contents) throw new Error("Empty response from target website.");

            // Parse the real website
            const parser = new DOMParser();
            const doc = parser.parseFromString(data.contents, "text/html");

            // 4. CLEANUP (Remove ads, scripts, navbars to get just text)
            const title = doc.title || url;
            
            // Remove junk elements
            const badTags = ['script', 'style', 'iframe', 'noscript', 'nav', 'footer', 'header', 'aside', 'svg', 'button', 'form'];
            badTags.forEach(tag => {
                const elements = doc.querySelectorAll(tag);
                elements.forEach(el => el.remove());
            });

            // Get text from body
            let rawText = doc.body.innerText || doc.body.textContent;
            
            // Format text: condense massive whitespace gaps
            let cleanText = rawText
                .replace(/\n\s*\n/g, '\n\n') // Replace multiple empty lines with just two
                .replace(/[ \t]+/g, ' ')     // Replace multiple spaces with one
                .trim();

            if (cleanText.length < 100) {
                cleanText += "\n\n[WARNING: This site might require JavaScript/Cookies to view content. Scraper returned minimal data.]";
            }

            // Output final result
            printContent(title, cleanText, url);

        } catch (err) {
            error(`Failed to scrape target site: ${err.message}`);
            log("Tip: Some sites (Twitter, Facebook, StackOverflow) block proxies.");
        }
    }

    run();
</script>
</body>
</html>
